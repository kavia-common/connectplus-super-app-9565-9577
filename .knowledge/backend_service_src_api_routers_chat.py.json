{"is_source_file": true, "format": "Python", "description": "This source file defines API endpoints for chat functionalities, including sending messages, retrieving chat history, interacting with an AI engine, managing conversations, and storing messages in a MongoDB database. It uses FastAPI for routing and httpx for asynchronous HTTP calls.", "external_files": ["src/core/auth", "src/core/db", "src/core/rate_limit", "src/core/settings", "src/core/utils", "src/models/chat"], "external_methods": ["src.core.auth.get_current_user", "src.core.db.get_db", "src.core.rate_limit.InMemoryRateLimiter", "src.core.rate_limit.RateLimitConfig", "src.core.settings.get_settings", "src.core.utils.now_utc", "src.core.utils.oid", "src.core.utils.serialize_doc"], "published": ["router"], "classes": [{"name": "ChatHistoryOut", "description": "Output model for chat history, including messages, conversation ID, user ID, and next cursor."}, {"name": "ChatMessageOut", "description": "Represents an individual chat message with id, sender, text, payload, and creation time."}, {"name": "ChatSendIn", "description": "Input model for sending a chat message, including message text and optional context."}, {"name": "ChatSendOut", "description": "Output model for the response when a message is sent, including reply, suggested actions, conversation ID, and message IDs."}], "methods": [{"name": "Dict[str,Any] _get_or_create_conversation(db: Database, user_id: str)", "description": "Retrieves the most recent conversation for a user or creates a new one if none exists.", "scope": "", "scopeKind": ""}, {"name": "_store_message(db: Database, conversation_id: ObjectId, sender: str, text: Optional[str], payload: Optional[dict])", "description": "Stores a message (either from user or AI) into the database, updating the last message timestamp.", "scope": "", "scopeKind": ""}, {"name": "Dict[str,Any] _call_ai_engine(user: AuthUser, message: str, context: Optional[dict])", "description": "Calls the external AI engine asynchronously with user message and context, returning the AI's reply and suggested actions.", "scope": "", "scopeKind": ""}, {"name": "chat_send( body: ChatSendIn, user: AuthUser = Depends(get_current_user), db: Database = Depends(get_db), )", "description": "Endpoint to handle sending a message to the AI, storing both user message and AI reply, and returning the response data.", "scope": "", "scopeKind": ""}, {"name": "chat_history( user: AuthUser = Depends(get_current_user), limit: int = Query(20, ge=1, le=100), cursor: Optional[str] = Query(None, description=\"Message id cursor (fetch messages before this id).\"), db: Database = Depends(get_db), )", "description": "Endpoint to fetch chat history for the current user's latest conversation with pagination.", "scope": "", "scopeKind": ""}], "calls": ["src.core.auth.get_current_user", "src.core.db.get_db", "src.core.rate_limit.InMemoryRateLimiter.check", "_get_or_create_conversation", "_store_message", "_call_ai_engine"], "search-terms": ["chat API", "AI conversation storage", "MongoDB chat messages", "FastAPI chat endpoints", "chat history retrieval", "rate limiting"], "state": 2, "file_id": 9, "knowledge_revision": 39, "git_revision": "133416b960eba02908dcd7a99c1ee182fc1486fd", "ctags": [{"_type": "tag", "name": "_call_ai_engine", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^async def _call_ai_engine(user: AuthUser, message: str, context: Optional[dict]) -> Dict[str, An/", "language": "Python", "typeref": "typename:Dict[str,Any]", "kind": "function", "signature": "(user: AuthUser, message: str, context: Optional[dict])"}, {"_type": "tag", "name": "_get_or_create_conversation", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^def _get_or_create_conversation(db: Database, user_id: str) -> Dict[str, Any]:$/", "language": "Python", "typeref": "typename:Dict[str,Any]", "kind": "function", "signature": "(db: Database, user_id: str)"}, {"_type": "tag", "name": "_rate_limiter", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^_rate_limiter = InMemoryRateLimiter($/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_settings", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^_settings = get_settings()$/", "language": "Python", "kind": "variable"}, {"_type": "tag", "name": "_store_message", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^def _store_message(db: Database, conversation_id: ObjectId, sender: str, text: Optional[str], pa/", "language": "Python", "kind": "function", "signature": "(db: Database, conversation_id: ObjectId, sender: str, text: Optional[str], payload: Optional[dict])"}, {"_type": "tag", "name": "chat_history", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^def chat_history($/", "language": "Python", "kind": "function", "signature": "( user: AuthUser = Depends(get_current_user), limit: int = Query(20, ge=1, le=100), cursor: Optional[str] = Query(None, description=\"Message id cursor (fetch messages before this id).\"), db: Database = Depends(get_db), )"}, {"_type": "tag", "name": "chat_send", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^async def chat_send($/", "language": "Python", "kind": "function", "signature": "( body: ChatSendIn, user: AuthUser = Depends(get_current_user), db: Database = Depends(get_db), )"}, {"_type": "tag", "name": "router", "path": "/home/kavia/workspace/code-generation/connectplus-super-app-9565-9577/backend_service/src/api/routers/chat.py", "pattern": "/^router = APIRouter(prefix=\"\\/api\\/chat\", tags=[\"Chat\"])$/", "language": "Python", "kind": "variable"}], "hash": "38c319e9e7b2ce9d3a0485d411ac9c74", "format-version": 4, "code-base-name": "backend_service", "filename": "backend_service/src/api/routers/chat.py", "fields": [{"name": "_rate_limiter = InMemoryRateLimiter(", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "_settings = get_settings()", "scope": "", "scopeKind": "", "description": "unavailable"}, {"name": "router = APIRouter(prefix=\"\\/api\\/chat\", tags=[\"Chat\"])", "scope": "", "scopeKind": "", "description": "unavailable"}], "revision_history": [{"39": "133416b960eba02908dcd7a99c1ee182fc1486fd"}]}